import argparse
import json
import sys

from client import Client
from server import Server
from util import ok


def main():
    parser = argparse.ArgumentParser(description='DNS Exfiltrator')
    parser.add_argument('config', action="store", default=None, help="Configuration file (json)")
    app_mode = parser.add_mutually_exclusive_group()
    app_mode.add_argument('-L', action="store_true", dest="server", default=False, help="Server mode")
    app_mode.add_argument('-E', action="store_true", dest="client", default=False, help="Client mode")
    args = parser.parse_args()

    # App set-up
    if args.config is None:
        print("Specify a configuration file!")
        parser.print_help()
        sys.exit(-1)

    with open(args.config) as data_file:
        config = json.load(data_file)

    # catch Ctrl+C
    # signal.signal(signal.SIGINT, signal_handler)
    ok(f"CTRL+C to kill {'server' if args.server else 'client'}.")

    # Server mode
    if args.server:
        app = Server(config)

    # Client mode
    else:
        app = Client(config)

    app.start()


if __name__ == '__main__':
    main()
